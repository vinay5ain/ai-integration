<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cart - FoodMood AI</title>
  <link rel="stylesheet" href="./style.css">
</head>
<body>

<header>
  <div class="logo">FoodMood AI</div>
  <nav>
    <a href="index.html">Home</a>
  </nav>
</header>

<div id="cart">
  <h2>Your Cart</h2>
  <ul id="cart-items"></ul>
  <button id="checkoutBtn">Checkout</button>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  const cartList = document.getElementById('cart-items');

  async function fetchCart() {
    const res = await fetch('/api/cart');
    const cartItems = await res.json();
    renderCart(cartItems);
  }

  function renderCart(items) {
    cartList.innerHTML = '';
    if(items.length === 0){
      cartList.innerHTML = '<li>Your cart is empty.</li>';
      return;
    }
    items.forEach((item) => {
      const li = document.createElement('li');
      li.innerHTML = `
        ${item.name} - â‚¹${item.price}
        <button onclick="removeItem(${item.id})">Remove</button>
      `;
      cartList.appendChild(li);
    });
  }

  async function removeItem(dishId) {
    await fetch('/api/cart', {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: dishId })
    });
    fetchCart();
  }

  document.getElementById('checkoutBtn').addEventListener('click', async () => {
    const res = await fetch('/api/cart');
    const cartItems = await res.json();
    if(cartItems.length === 0) return alert('Cart is empty.');

    const amount = cartItems.reduce((sum, item) => sum + item.price, 0);

    // Create Razorpay order
    const orderRes = await fetch('/api/create_order', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ amount })
    });
    const orderData = await orderRes.json();

    const options = {
      key: 'rzp_test_RJh8bVllLjVPa8', // Your Razorpay key
      amount: orderData.amount,
      currency: orderData.currency,
      name: "FoodMood AI",
      description: "Order Payment",
      order_id: orderData.id,
      handler: async function(response){
        const verifyRes = await fetch('/api/verify_payment', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(response)
        });
        const verifyData = await verifyRes.json();
        if(verifyData.status === 'success'){
          alert('Payment Successful!');
        } else {
          alert('Payment Verification Failed.');
        }
        fetchCart();
      },
      theme: { color: "#4a90e2" }
    };
    const rzp = new Razorpay(options);
    rzp.open();
  });

  fetchCart();
</script>

</body>
</html>
